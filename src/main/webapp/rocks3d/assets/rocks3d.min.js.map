{"version":3,"sources":["app/app.ts","config/config.ts","cluster/cluster.ts","mapview/mapview.ts","message/mesasge.ts","navigator/navigator.ts","particles/particles.ts","multisurface/multisurface.ts","surface/surface.ts","view/view.ts","templates.ts"],"names":["rocks3dApp","angular","module","config","$locationProvider","html5Mode","enabled","requireBase","rocks3d","context","surface","resolution","elevation1SecUrl_delayed","elevation1SecUrl","elevationBandannaUrl","elevation1SecSmoothedUrl","elevation5MUrl","imageryUrls","national","url","nsw","extent","xmin","xmax","ymin","ymax","surfaceOpacity","listenDataLoadedEventName","listenRendererSelectEventName","mapConfig","options","maxBounds","center","minZoom","zoom","position","bounds","layer","name","type","parameters","defaultLayer","isBaselayer","visible","listenForExtentEvent","listenForMarkerEvent","particles","dataUrl","x","y","maxCount","onhoverEventName","dataLoadedEventName","rendererSelectEventName","scene","camera","z","light","onloadEventName","factory","getConfig","what","cluster","directive","rocks3dClusterService","link","scope","init","$http","rocks3dMapService","rocks3dNavigatorService","sequence","service","getMap","then","map","movePan","event","removeLayer","instanceSequence","getZoom","getBounds","parms","push","Math","max","getWest","min","getEast","getSouth","getNorth","get","join","result","maxRadius","sqrt","d3","data","features","item","properties","count","L","geoJson","pointToLayer","feature","latlng","geojsonMarkerOptions","radius","fillColor","color","weight","opacity","fillOpacity","marker","circleMarker","bindLabel","noHide","on","id","this","split","to","addTo","mapview","restrict","element","attrs","createMap","$document","$q","$rootScope","configService","addLayer","leafLayer","expandLayer","Clazz","isArray","forEach","length","poly","waiters","deferred","when","defer","promise","makeMarker","point","SAMPLE_LONGITUDE","coordinates","SAMPLE_LATITUDE","geometry","html","bindPopup","openPopup","makePoly","fitBounds","animate","padding","Map","control","scale","imperial","mousePosition","emptyString","seperator","latFormatter","lat","Util","formatNum","lngFormatter","lng","$on","geojson","prom","resolve","message","$timeout","messageTimer","text","messageArea","document","getElementById","innerHTML","style","display","navigator","where","navigate","hash","getHash","doc","setHash","location","createParameters","xyz","delta","navigateY","navigateX","navigateParent","floor","yes","rocks3dParticlesService","controller","$location","rocks3dMessageService","rocks3dSurfaceService","addLights","state","add","THREE","AmbientLight","DirectionalLight","set","load","tile","console","log","createFeatures","all","prime","json","d","allData","window","requestAnimationFrame","renderer","clear","lookAt","render","controls","update","heightData","heightExtent","loaded","totalFeatures","i","SAMPLE_ELEVATION","unfiltered","xExtent","yExtent","zExtent","vpts","extents","xMax","xCen","xMin","yMax","yCen","yMin","zMax","zCen","zMin","aspectRatio","cos","PI","LENGTH_DEGREE","width","height","colour","category20c","linear","domain","range","lineGeo","getLineGeo","lineMat","LineBasicMaterial","transparent","line","Line","scatterPlot","titleX","createText2D","valueX","format","titleY","valueY","titleZ","mat","PointsMaterial","vertexColors","VertexColors","size","pointCount","objects","pointGeo","Geometry","p","Vector3","vertices","colors","Color","setRGB","hexToRgb","r","g","b","computeBoundingSphere","boundingSphere","points","Points","down","Date","getTime","sx","sy","domElement","onmousedown","ev","rect","getBoundingClientRect","clientX","clientY","mouse","Vector2","left","clientWidth","top","clientHeight","$broadcast","onmouseup","raycaster","Raycaster","onmousemove","decorateHtml","br","replace","toFixed","property","hasOwnProperty","preventDefault","setFromCamera","intersects","intersectObject","index","OrbitControls","xScale","yScale","zScale","v","createTextCanvas","font","canvas","createElement","ctx","getContext","fontStr","w","measureText","h","ceil","fillStyle","fillText","segW","segH","plane","PlaneGeometry","tex","Texture","needsUpdate","planeMat","MeshBasicMaterial","mesh","Mesh","hex","exec","parseInt","bootstrap","createFilters","filterArr","filters","filter","encodeURIComponent","conditional","search","key","value","setter","createTileInfo","indexOf","createPointParameters","xyzoom","parts","parseFloat","resizer","WebGLRenderer","antialias","setSize","appendChild","setClearColor","PerspectiveCamera","Scene","THREEExt","WindowResize","container","Object3D","rotation","tileInfo","bbox","multisurface","transformUrl","provider","metadataLocation","metadata","$get","getMetadata","cache","response","waiter","urls","urlTemplates","show","loader","DataSurfaceLoader","elevation","imagery","toBbox","bboxArr","lastData","sceneProperties","wcs1sec","terrainLoader","GeotiffTerrainLoader","checkElevation","xy","baseUrl","nswExtent","TextureLoader","crossOrigin","material","MeshPhongMaterial","vertice","computeFaceNormals","computeVertexNormals","view","templateUrl","direction","change","props","smaller","larger","oneToOne","dimensions","ratio","run","$templateCache","put"],"mappings":"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","file":"rocks3d.min.js","sourcesContent":["/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\n'use strict';\r\n\r\nmodule rocks3dApp {\r\n\t\r\nangular.module(\"Rocks3dApp\", [\r\n   'rocks3d.cluster',\r\n   'rocks3d.config',\r\n   'rocks3d.map',\r\n   'rocks3d.message',\r\n   'rocks3d.multisurface',\r\n   'rocks3d.navigator',\r\n   'rocks3d.particles',\r\n   //'rocks3d.surface',\r\n   'rocks3d.templates',\r\n   'rocks3d.view'\r\n]).config(['$locationProvider', function($locationProvider: ng.ILocationProvider) {\r\n    $locationProvider.html5Mode({\r\n        enabled: true,\r\n        requireBase: false\r\n      });\r\n}]);\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\nmodule rocks3d.config {\r\n'use strict';\r\n\r\nvar context: any = {};\r\n\r\ncontext.surface = {\r\n\tresolution: 200,\r\n\televation1SecUrl_delayed: \"http://services.ga.gov.au/gis/services/DEM_SRTM_1Second_Hydro_Enforced/MapServer/WCSServer\" +\r\n\t\t\"?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326\" +\r\n\t\t//\"&BBOX={xmin},{ymin},{xmax},{ymax}\" +\r\n\t\t\"&BBOX={bbox}\" + \r\n\t\t\"&FORMAT=GeoTIFF&RESX={resolution}\" + \r\n\t\t\"&RESY={resolution}&RESPONSE_CRS=EPSG:4326\" +\r\n\t\t\"&HEIGHT={resolution}&WIDTH={resolution}\",\r\n\t//elevationBrowseUrl: \"http://services.ga.gov.au/gis/services/Browse_Basin_Bathymetry_2014_GA0345_GA0346_TAN1411/MapServer/WCSServer\" +\r\n\televation1SecUrl: \"/arcgis/services/Great_Artesian_Basin_groundwater/MapServer/WCSServer\" +\r\n\t\t\t\"?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326\" +\r\n\t\t\t//\"&BBOX={xmin},{ymin},{xmax},{ymax}\" +\r\n\t\t\t\"&BBOX={bbox}\" + \r\n\t\t\t\"&FORMAT=GeoTIFF&RESX={resolution}\" + \r\n\t\t\t\"&RESY={resolution}&RESPONSE_CRS=EPSG:4326\" + \r\n\t\t\t\"&HEIGHT={resolution}&WIDTH={resolution}\",\r\n\televationBandannaUrl: \"http://win-amap-test01:6080/arcgis/services/Bandanna_Top_Galilee_groundwater/MapServer/WCSServer\" +\r\n\t\t\"?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326\" +\r\n\t\t//\"&BBOX={xmin},{ymin},{xmax},{ymax}\" +\r\n\t\t\"&BBOX={bbox}\" + \r\n\t\t\"&FORMAT=GeoTIFF&RESX={resolution}\" + \r\n\t\t\"&RESY={resolution}&RESPONSE_CRS=EPSG:4326\" +\r\n\t\t\"&HEIGHT={resolution}&WIDTH={resolution}\",\r\n\televation1SecSmoothedUrl: \"http://www.ga.gov.au/gisimg/services/topography/dem_s_1s/ImageServer/WCSServer\" +\r\n\t\t\"?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326\" +\r\n\t\t//\"&BBOX={xmin},{ymin},{xmax},{ymax}\" +\r\n\t\t\"&BBOX={bbox}\" + \r\n\t\t\"&FORMAT=GeoTIFF&RESX={resolution}\" + \r\n\t\t\"&RESY={resolution}&RESPONSE_CRS=EPSG:4326\" +\r\n\t\t\"&HEIGHT={resolution}&WIDTH={resolution}\",\r\n\televation5MUrl: \"http://services.ga.gov.au/gis/services/DEM_LiDAR_5m/MapServer/WCSServer\" +\r\n\t\t\"?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326\" +\r\n\t\t//\"&BBOX={xmin},{ymin},{xmax},{ymax}\" +\r\n\t\t//\"&BBOX={xmin},{ymin},{xmax},{ymax}\" +\r\n\t\t\"&BBOX={bbox}\" + \r\n\t\t\"&FORMAT=GeoTIFF&RESX={resolution}\" + \r\n\t\t\"&RESY={resolution}&RESPONSE_CRS=EPSG:4326\" +\r\n\t\t\"&HEIGHT={resolution}&WIDTH={resolution}\",\r\n\timageryUrls: {\r\n\t\tnational: {\r\n\t\t\t// url: \"http://www.ga.gov.au/gisimg/services/topography/World_Bathymetry_Image_WM/MapServer/\" +\r\n\t\t\turl: \"http://win-amap-test01:6080/arcgis/services/Great_Artesian_Basin_groundwater/MapServer/WMSServer\" +\r\n\t\t\t\t\"?LAYERS=0\" +\r\n\t\t\t\t\"&TRANSPARENT=TRUE\" +\r\n\t\t\t\t\"&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=\" +\r\n\t\t\t\t\"&FORMAT=image%2Fpng\" +\r\n\t\t\t\t\"&SRS=EPSG%3A4326\" +\r\n\t\t\t\t\"&BBOX={bbox}\" + // Tassie 140,-46,150,-37\r\n\t\t\t\t\"&WIDTH=512&HEIGHT=512\"\t\t\t\t\r\n\t\t},\r\n\t\tnsw: {\r\n\t\t\turl: \"http://maps.six.nsw.gov.au/arcgis/services/public/NSW_Imagery/MapServer/WMSServer\" +\r\n\t\t\t\t\"?LAYERS=BestImageryDates\" +\r\n\t\t\t\t\"&TRANSPARENT=TRUE\" +\r\n\t\t\t\t\"&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=\" +\r\n\t\t\t\t\"&FORMAT=image%2Fpng\" +\r\n\t\t\t\t\"&SRS=EPSG%3A4326\" +\r\n\t\t\t\t\"&BBOX={bbox}\" + // Tassie 140,-46,150,-37\r\n\t\t\t\t\"&WIDTH=512&HEIGHT=512\",\r\n\t\t\textent: {\r\n\t\t\t\txmin: 141,\r\n\t\t\t\txmax: 151.3,\r\n\t\t\t\tymin: -35,\r\n\t\t\t\tymax: -28.5\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tsurfaceOpacity:0.1,\r\n\tlistenDataLoadedEventName: 'rocks3ddataloaded',\r\n\tlistenRendererSelectEventName: 'rocks3donselected'\r\n};\r\n\r\ncontext.mapConfig = {\r\n    options: {  \r\n\t\tmaxBounds: [[-48, 106],[-6, 159]],\r\n\t    center: [-28, 135],\r\n\t    minZoom: 4,\r\n\t    zoom: 5\r\n\t},\r\n    position: {  \r\n        bounds: [  \r\n           [-44, 117],\r\n           [-12, 146]\r\n        ],\r\n        minZoom: 13\r\n     },\r\n     layer: {  \r\n         \"name\":\"Google Hybrid\",\r\n         \"type\":\"Google\",\r\n         \"parameters\":[\"HYBRID\"],\r\n         \"defaultLayer\":true,\r\n         \"isBaselayer\":true,\r\n         \"visible\":true\r\n      },\r\n\tlistenForExtentEvent: 'rocks3ddrawpolygon', // If we  get this event we know we have a polygon to draw\r\n\tlistenForMarkerEvent: 'rocks3ddrawmarker'\r\n};\r\n\r\n// The particle system configuration\r\ncontext.particles = {\r\n\tdataUrl: \"http://www.ga.gov.au/geophysics-rockpropertypub-gws/ga_rock_properties_wfs/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ga_rock_properties_wfs:remanent_magnetisation,ga_rock_properties_wfs:scalar_results&maxFeatures=50&outputFormat=application%2Fgml%2Bxml%3B+version%3D3.2&featureID={id}\",\r\n\turl: \"service/tile/\",\r\n\tx: 138,\r\n\ty: -28,\r\n\tzoom: 4,\r\n\tmaxCount: 300000,\r\n\tonhoverEventName: 'rocks3ddrawmarker',\r\n\tdataLoadedEventName: 'rocks3ddataloaded',\r\n\trendererSelectEventName: 'rocks3donselected',\r\n}; \r\n\r\ncontext.scene = {\r\n\tcamera: {\r\n\t\tz: 200,\r\n\t\tx: -100,\r\n\t\ty: 100\r\n\t},\r\n\tlight: {\r\n\t\tposition: {\r\n\t\t\tx: 100,\r\n\t\t\ty: 500,\r\n\t\t\tz: 0\r\n\t\t}\r\n\t},\r\n\tonloadEventName: 'rocks3ddrawpolygon' // There should be someone listening for this event.\t\r\n};\r\n\r\nexport interface IConfigService {\r\n\tgetConfig(what?: string): any;\r\n}\r\n\r\nangular.module('rocks3d.config', [])\r\n\r\n.factory('configService', [function() {\r\n\treturn {\r\n\t\tgetConfig: function(what: string): any {\r\n\t\t\tif(!what) {\r\n\t\t\t\treturn context;\r\n\t\t\t} else {\r\n\t\t\t\treturn context[what];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}])\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\nmodule rocks3d.cluster {\r\n'use strict';\t\r\n\r\nangular.module('rocks3d.cluster', [])\r\n\r\n.directive('rocks3dCluster', ['rocks3dClusterService', function(rocks3dClusterService: any) {\r\n\treturn {\r\n\t\tlink: function(scope: any) {\r\n\t\t\trocks3dClusterService.init();\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.factory('rocks3dClusterService', ['$http', 'rocks3dMapService', 'rocks3dNavigatorService',\r\n                                   function($http: ng.IHttpService, rocks3dMapService: any, rocks3dNavigatorService: any) {\r\n\tvar url = \"service/rocks/summary\";\r\n\tvar sequence = 0;\r\n\tvar service:any = {};\r\n\tvar busy = false;\r\n\tvar layer: any;\r\n\t\r\n\t\r\n\t\r\n\tservice.init = function() {\r\n\t\trocks3dMapService.getMap().then(function(map: any) {\r\n\t\t    map.on('zoomend', movePan);\r\n\r\n\t\t    map.on('dragend', movePan);\r\n\r\n\t\t    function movePan(event: ng.IAngularEvent) {\r\n\t\t    \tif(layer) {\r\n\t\t    \t\tmap.removeLayer(layer);\r\n\t\t    \t\tlayer = null;\r\n\t\t    \t}\r\n\t\t    \t\r\n\t\t    \tvar instanceSequence = ++sequence;\r\n\t\t    \tvar zoom = map.getZoom();\r\n\t\t    \tvar bounds = map.getBounds();\r\n\t\t    \tvar parms: string[] = [];\r\n\t\t    \tparms.push(\"xmin=\" + Math.max(bounds.getWest() - 20/zoom, -180)); + \r\n\t\t    \tparms.push(\"xmax=\" + Math.min(bounds.getEast() + 20/zoom, 180));\r\n\t\t    \tparms.push(\"ymin=\" + Math.max(bounds.getSouth() - 10/zoom, -90));\r\n\t\t    \tparms.push(\"ymax=\" + Math.min(bounds.getNorth() + 10/zoom, 90)); \r\n\t\t    \tparms.push(\"zoom=\" + (Math.max(zoom, 2)));\r\n\t\t    \t\r\n\t\t    \tvar geojsonMarkerOptions = {\r\n\t\t    \t\t    radius: 8,\r\n\t\t    \t\t    fillColor: \"#ff7800\",\r\n\t\t    \t\t    color: \"#000\",\r\n\t\t    \t\t    weight: 1,\r\n\t\t    \t\t    opacity: 1,\r\n\t\t    \t\t    fillOpacity: 0.8\r\n\t\t    \t\t};\r\n\t\t    \t\r\n\t\t    \t\r\n\t\t    \t$http.get(url + \"?\" + parms.join(\"&\")).then(function(result: any) {\r\n\t\t    \t\tif(instanceSequence < sequence) {\r\n\t\t    \t\t\treturn;\r\n\t\t    \t\t}\r\n\t\t    \t\tvar maxRadius = Math.sqrt(d3.max(result.data.features, function(item: any) {\r\n\t\t    \t\t\treturn item.properties.count;\r\n\t\t    \t\t}));\r\n\t\t    \t\t\r\n\t\t    \t\tlayer = L.geoJson(result.data, {\r\n\t\t    \t\t    pointToLayer: function (feature: any, latlng: L.LatLng) {\r\n\t\t    \t\t    \tvar geojsonMarkerOptions = {\r\n\t\t    \t\t    \t    radius: 4 + 20/maxRadius * Math.sqrt(feature.properties.count),\r\n\t\t    \t\t    \t    fillColor: \"#ff7800\",\r\n\t\t    \t\t    \t    color: \"#000\",\r\n\t\t    \t\t    \t    weight: 1,\r\n\t\t    \t\t    \t    opacity: 1,\r\n\t\t    \t\t    \t    fillOpacity: 0.8\r\n\t\t    \t\t    \t};\r\n\t\t    \t\t        var marker = L.circleMarker(latlng, geojsonMarkerOptions)\r\n\t\t    \t\t        \t.bindLabel(\"\" + feature.properties.count, { noHide: true });\r\n\t\t    \t\t        \r\n\t\t    \t\t        marker.on(\"click\", function() {\r\n\t\t    \t\t        \tvar id = this.feature.id.split(\"/\");\r\n\t\t    \t\t        \t\r\n\t\t    \t\t        \trocks3dNavigatorService.to({\r\n\t\t    \t\t        \t\tzoom: id[0],\r\n\t\t    \t\t        \t\tx: id[1],\r\n\t\t    \t\t        \t\ty: id[2]\r\n\t\t    \t\t        \t})\r\n\t\t    \t\t        });\r\n\t\t    \t\t        return marker;\r\n\t\t    \t\t    }\r\n\t\t    \t\t}).addTo(map);\r\n\t\t    \t});\r\n\t\t    }\t\t\t\r\n\t\t});\r\n\t}\t\r\n\treturn service;\r\n}]);\r\n\r\n}\r\n","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n/// <reference path=\"../config/config.ts\" />\r\n\r\nmodule rocks3d.mapview {\r\n'use strict';\r\n\r\nangular.module('rocks3d.map', []).directive(\"rocks3dMap\", ['rocks3dMapService', function(rocks3dMapService: any) {\r\n\treturn {\r\n\t\trestrict: 'AE',\r\n\t\tlink: function(scope: ng.IScope, element: any, attrs: ng.IAttributes) {\r\n\t\t\trocks3dMapService.createMap(attrs[\"id\"]);\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.factory('rocks3dMapService', ['$document', '$q', '$rootScope', 'configService', \r\n                      function($document: ng.IDocumentService, $q: ng.IQService, $rootScope: ng.IRootScopeService, configService: rocks3d.config.IConfigService) {\r\n\tvar map: L.Map, poly: any, marker: any;\r\n\tvar service: any = {};\r\n    var config = configService.getConfig('mapConfig');\r\n    var waiters: ng.IDeferred<any>[] = [];\r\n\t\r\n    service.getMap = function() {\r\n    \tvar deferred: ng.IDeferred<any>;\r\n    \tif(map) {\r\n    \t\treturn $q.when(map);\r\n    \t} else {\r\n    \t\tdeferred = $q.defer();\r\n    \t\twaiters.push(deferred);\r\n    \t\treturn deferred.promise;\r\n    \t}\r\n    };\r\n    \r\n\tservice.createMap = function(element: any) {\r\n\t\tmap = new L.Map(element, {center: config.options.center, zoom: config.options.zoom});\r\n\t\taddLayer(config.layer, map);\r\n\r\n\t\tL.control.scale({imperial:false}).addTo(map);\r\n\t\tL.control.mousePosition({\r\n\t\t\tposition:\"bottomright\", \r\n\t\t\temptyString:\"\",\r\n\t\t\tseperator : \" \",\r\n\t\t\tlatFormatter : function(lat: number) {\r\n\t\t\t\treturn \"Lat \" + L.Util.formatNum(lat, 5) + \"°\";\r\n\t\t\t},\r\n\t\t\tlngFormatter : function(lng: number) {\r\n\t\t\t\treturn \"Lng \" + L.Util.formatNum(lng, 5) + \"°\";\r\n\t\t\t}\r\n\t\t}).addTo(map);\r\n\r\n\t\tif(config.listenForExtentEvent) {\r\n\t\t\t$rootScope.$on(config.listenForExtentEvent, function showBbox(event: any, geojson: GeoJSON.Feature) {\t\r\n\t\t\t\t// It's a GeoJSON Polygon geometry and it has a single ring.\r\n\t\t\t\tservice.getMap().then(function() {\r\n\t\t\t\t\tmakePoly(geojson);\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t});\t\t\t\r\n\t\t}\r\n\r\n\t\tif(config.listenForMarkerEvent) {\r\n\t\t\t$rootScope.$on(config.listenForMarkerEvent, function showBbox(event, geojson) {\t\r\n\t\t\t\t// It's a GeoJSON Polygon geometry and it has a single ring.\r\n\t\t\t\tservice.getMap().then(function() {\r\n\t\t\t\t\tmakeMarker(geojson);\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t});\t\t\t\r\n\t\t}\r\n\r\n\t\tif(waiters) {\r\n\t\t\twaiters.forEach(function(prom) {\r\n\t\t\t\tprom.resolve(map);\r\n\t\t\t});\r\n\t\t\twaiters = null;\r\n\t\t}\r\n\t\tfunction makeMarker(data: any) {\r\n\t\t\tvar point: any;\r\n\t\t\tif(typeof data.properties.SAMPLE_LONGITUDE != \"undefined\") {\r\n\t\t\t\tpoint= {\r\n\t\t\t\t\ttype: \"Point\",\r\n\t\t\t\t\tcoordinates: [\r\n\t\t\t\t\t\tdata.properties.SAMPLE_LONGITUDE,\r\n\t\t\t\t\t\tdata.properties.SAMPLE_LATITUDE\r\n\t\t\t\t\t]\r\n\t\t\t\t};\r\n\t\t\t} else {\r\n\t\t\t\tpoint = data.geometry;\r\n\t\t\t}\r\n\t\t\tif(marker) {\r\n\t\t\t\tmap.removeLayer(marker);\r\n\t\t\t}\r\n\t\t\tmarker = L.geoJson({\r\n\t\t\t\ttype:\"Feature\",\r\n\t\t\t\tgeometry: point,\r\n\t\t\t\tid: data.id\r\n\t\t\t}).addTo(map);\r\n\t\t\tif(data.properties.html) {\r\n\t\t\t\tmarker.bindPopup(data.properties.html).openPopup();\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tfunction makePoly(data: GeoJSON.Feature) {\r\n\t\t\tif(poly) {\r\n\t\t\t\tmap.removeLayer(poly);\r\n\t\t\t}\r\n\t\t\tpoly = L.geoJson(data).addTo(map);\r\n\t\t\t\r\n\t\t\tmap.fitBounds(poly.getBounds(), {\r\n\t\t\t\tanimate: true,\r\n\t\t\t\tpadding: L.point(100,100)\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tfunction clip(num: number, min: number, max: number) {\r\n\t\t\treturn Math.min(Math.max(num, min), max);\r\n\t\t}\t\t\r\n\t};\r\n   \r\n\treturn service;\r\n\t\r\n\tfunction addLayer(layer: any, map: L.Map) {\r\n\t\tvar leafLayer = expandLayer(layer);\r\n\t\tmap.addLayer(leafLayer);\t\t\r\n\t}\r\n\t\r\n\tfunction expandLayer(data: any) {\r\n\t\tvar Clazz: any = [];\r\n\t\tif(angular.isArray(data.type)) {\r\n\t\t\tClazz = L;\r\n\t\t\tdata.type.forEach(function(type: any) {\r\n\t\t\t\tClazz = Clazz[type];\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tClazz = L[data.type];\r\n\t\t}\r\n\t\tif(data.parameters && data.parameters.length > 0) {\r\n\t\t\treturn new Clazz(data.parameters[0], data.parameters[1], data.parameters[2], data.parameters[3], data.parameters[4]);\r\n\t\t} \r\n\t\treturn new Clazz();\r\n\t}\r\n}]);\r\n\t\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\nmodule rocks3d.message {\r\n'use strict';\t\r\n\r\nangular.module('rocks3d.message', [])\r\n\r\n.factory('rocks3dMessageService', ['$timeout', function($timeout: ng.ITimeoutService) {\r\n\tvar messageTimer: any;\r\n\tvar service: any = {};\r\n\t\r\n\tservice.message = function(text: string) {\r\n\t\tvar messageArea = document.getElementById(\"message-details\");\r\n\t\t\r\n\t\tif(messageTimer) {\r\n\t\t\tmessageTimer();\r\n\t\t\tmessageTimer = null;\r\n\t\t}\r\n\t\t\r\n\t\tmessageArea.innerHTML = text;\r\n\t\tmessageArea.style.display = \"inline-block\";\r\n\t\t\r\n\t\tmessageTimer = $timeout(function() {\r\n\t\t\tmessageArea.style.display = \"none\";\r\n\t\t}, 12000);\t\r\n\t};\r\n\t\r\n\treturn service;\r\n}]);\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\nmodule rocks3d.navigator {\r\n'use strict';\t\r\n\r\nexport interface NavigateScope extends ng.IScope {\r\n\twhere: any;\r\n}\r\n\r\nangular.module('rocks3d.navigator', [])\r\n\r\n.directive('rocks3dNavigate', ['rocks3dNavigatorService', \r\n\t\tfunction(rocks3dNavigatorService: any) {\r\n\treturn {\r\n\t\trestrict: 'AE',\r\n\t\tscope: {\r\n\t\t\twhere: \"=\"\r\n\t\t},\r\n\t\tlink: function(scope: NavigateScope, element: ng.IAugmentedJQuery) {\r\n\t\t\telement.on('click', function() {\r\n\t\t\t\trocks3dNavigatorService.navigate(scope.where);\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.directive('rocks3dZoom', ['rocks3dNavigatorService', function(rocks3dNavigatorService: any) {\r\n\treturn {\r\n\t\trestrict: 'AE',\r\n\t\tscope: {\r\n\t\t\twhere: \"=\"\r\n\t\t},\r\n\t\tlink: function(scope: NavigateScope, element: ng.IAugmentedJQuery) {\r\n\t\t\telement.on('click', function() {\r\n\t\t\t\trocks3dNavigatorService.zoom(scope.where);\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.factory('rocks3dNavigatorService', ['$document', 'configService', function($document: ng.IDocumentService, configService: any) {\r\n\tvar service: any = {};\r\n\tvar data = configService.getConfig('particles');\r\n\t\r\n\tservice.zoom = function(where: any) {\r\n\t\tvar hash = data.getHash();\r\n\t\tvar zoom = hash.zoom + 1;\r\n\t\tvar x = hash.x * 2;\r\n\t\tvar y = hash.y * 2;\r\n\t\tvar doc: any = $document[0];\r\n\t\t\r\n\t\tif(where.x > 0) {\r\n\t\t\tx++;\r\n\t\t}\r\n\t\tif(where.y > 0) {\r\n\t\t\ty++;\r\n\t\t}\r\n\t\tdata.setHash({x:x, y:y, zoom:zoom});\r\n\t\tdoc.location = \"?hash=\" + data.createParameters();\r\n\t\t\r\n\t};\r\n\t\r\n\tservice.to = function(xyz: any) {\r\n\t\tvar doc: any = $document[0];\r\n\t\t\r\n\t\tdata.setHash(xyz);\r\n\t\tdoc.location = \"?hash=\" + data.createParameters();\r\n\t};\r\n\t\r\n\tservice.navigate = function(delta: any) {\r\n\t\tvar doc: any = $document[0];\r\n\t\t\r\n\t\tvar hash = data.getHash();\t\r\n\t\tvar yes = navigateParent();\r\n\t\tif(!yes) {\r\n\t\t\tyes = navigateY();\r\n\t\t\tif(!yes) {\r\n\t\t\t\tnavigateX();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tdoc.location = \"?hash=\" + data.createParameters();\r\n\t\t\r\n\t\tfunction navigateY() {\r\n\t\t\tif(delta.y) {\r\n\t\t\t\tdata.setHash({\r\n\t\t\t\t\tzoom: hash.zoom,\r\n\t\t\t\t\tx: hash.x,\r\n\t\t\t\t\ty: hash.y + delta.y\r\n\t\t\t\t});\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tfunction navigateX() {\r\n\t\t\tif(delta.x) {\r\n\t\t\t\tdata.setHash({\r\n\t\t\t\t\tzoom: hash.zoom,\r\n\t\t\t\t\tx: hash.x + delta.x,\r\n\t\t\t\t\ty: hash.y\r\n\t\t\t\t});\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t\r\n\t\tfunction navigateParent() {\r\n\t\t\tif(delta.zoom == -1) {\r\n\t\t\t\tdata.setHash({\r\n\t\t\t\t\tzoom: hash.zoom + delta.zoom,\r\n\t\t\t\t\tx: Math.floor(hash.x/2),\r\n\t\t\t\t\ty: Math.floor(hash.y/2)\r\n\t\t\t\t});\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t}\t\t\r\n\t\t\r\n\t\tfunction valueOf(data: any, fallOver: any) {\r\n\t\t\tif(typeof data == \"undefined\") {\r\n\t\t\t\treturn fallOver\r\n\t\t\t} \r\n\t\t\treturn data;\r\n\t\t}\r\n\t}\r\n\treturn service;\r\n\r\n}]);\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\nmodule rocks3d.particles {\r\n'use strict';\t\r\n\r\n\r\nangular.module('rocks3d.particles', [])\r\n\r\n.directive(\"rocks3dParticles\", ['rocks3dParticlesService', function(rocks3dParticlesService: any) {\r\n\treturn {\r\n\t\tlink: function(scope: ng.IScope, element: ng.IAugmentedJQuery) {\r\n\t\t\trocks3dParticlesService.init(element[0]);\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n// We use this for static views\r\n.controller('rocks3dParticlesCtrl', ['rocks3dParticlesService', function(rocks3dParticlesService: any) {\r\n\tthis.data = rocks3dParticlesService.data();\r\n}])\r\n\r\n.factory('rocks3dParticlesService', \r\n\t\t['$location', '$q', '$rootScope', '$timeout', 'configService', 'rocks3dMessageService', 'rocks3dSurfaceService',\r\n\t\t function($location: ng.ILocationService, $q: ng.IQService, $rootScope: ng.IRootScopeService, $timeout: ng.ITimeoutService, \r\n\t\t \t\tconfigService: any, rocks3dMessageService: any, rocks3dSurfaceService: any) {\r\n\tconst LENGTH_DEGREE = 111320; \r\n    var service: any = {};\r\n\tvar config = configService.getConfig('particles');\r\n\tvar data: any = {};\r\n\tvar state: any = {\r\n\t\tdata: data\r\n\t};\t\r\n\r\n\tvar w: number, h: number, scatterPlot: THREE.Object3D, format: any, unfiltered: any[], objects: any, resizer: any;\r\n\t\r\n\tbootstrap();\t\r\n\r\n\tservice.scene = function() {\r\n\t\treturn state;\r\n\t};\r\n\r\n\tservice.data = function() {\r\n\t\treturn data;\r\n\t};\r\n\t\r\n\tservice.init = function(element: any) {\r\n\t\tvar rect = element.getBoundingClientRect();\r\n\t\tw = rect.width;\r\n\t\th = rect.height;\r\n\r\n\t\tstate.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias : true\r\n\t\t});\r\n\r\n\t\tstate.renderer.setSize(w, h);\r\n\t\telement.appendChild(state.renderer.domElement);\r\n\r\n\t\tstate.renderer.setClearColor(0xffffff, 1.0);\r\n\t\t\r\n\t\tstate.camera = new THREE.PerspectiveCamera(45, w / h, 1, 10000);\r\n\t\tstate.camera.position.z = 200;\r\n\t\tstate.camera.position.x = -100;\r\n\t\tstate.camera.position.y = 100;\r\n\t\t\r\n\t\tstate.scene = new THREE.Scene();\r\n\t\t\r\n\t\tresizer = THREEExt.WindowResize(state.renderer, state.camera, element);\r\n\r\n\t\tscatterPlot = state.container = new THREE.Object3D();\r\n\t\tstate.scene.add(scatterPlot);\r\n\r\n\t\tscatterPlot.rotation.y = 0;\r\n\r\n\t\tunfiltered = [];\r\n\r\n\t\tformat = d3.format(\"+.5f\");\r\n\t\t\r\n\t\t\r\n\t\td3.json(config.createTileInfo(), function(d: any) {\r\n\t\t\t$timeout(function() {\r\n\t\t\t\tdata.tileInfo = d;\r\n\t\t\t\t$rootScope.$broadcast(config.onloadEventName, d);\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tvar hash = d.properties.hash;\r\n\t\t\t\r\n\t\t\tconfig.hash = hash.z + \"/\" + hash.x + \"/\" + hash.y;\r\n\t\t\t\r\n\t\t\td.extent = {\r\n\t\t\t\tx: [d.bbox[0], d.bbox[2]],\r\n\t\t\t\ty: [d.bbox[1], d.bbox[3]]\r\n\t\t\t}\t\r\n\t\t\tload(d);\r\n\t\t});\r\n\t\taddLights(state.scene);\r\n\t};\r\n\t\r\n\treturn service;\r\n\t\r\n\t\r\n\tfunction addLights(scene: THREE.Scene) {\r\n\t\tstate.scene.add(new THREE.AmbientLight(0x333333));\r\n\r\n\t\tvar light = new THREE.DirectionalLight( 0xffffff);\r\n\t\tlight.position.set( 100, 500, 0);\r\n\t\tstate.scene.add( light );\r\n\t}\r\n\r\n\tfunction load(tile: any) {\r\n\t\tvar zoom = tile.properties.hash.z;\r\n\t\t\r\n\t\tconsole.log(config.createFeatures());\r\n\t\t\r\n\t\t$q.all([rocks3dSurfaceService.prime(tile), (function() {\r\n\t\t\tvar deferred = $q.defer();\r\n\t\t\td3.json(config.createFeatures(), function(d) {\r\n\t\t\t\tdeferred.resolve(d);\r\n\t\t\t});\r\n\t\t\treturn deferred.promise;\r\n\t\t})()]).then(function(allData: any) {\r\n\t\t\tvar heightData = allData[0];\r\n\t\t\tvar heightExtent = d3.extent(heightData);\r\n\t\t\tvar d = allData[1];\r\n\r\n\t\t\t$timeout(function() {\r\n\t\t\t\tdata.loaded = d;\r\n\t\t\t});\r\n\t\t\tif(!d.totalFeatures) {\r\n\t\t\t\trocks3dMessageService.message(\"There are no features in the selected area.\");\r\n\t\t\t} else if(d.features.length < d.totalFeatures) {\r\n\t\t\t\trocks3dMessageService.message(\"Only showing \" + d.features.length + \" of \" + d.totalFeatures + \", refine your search area\");\r\n\t\t\t}\r\n\t\t\td.features.forEach(function(feature: GeoJSON.Feature, i: number) {\r\n\t\t\t\tvar properties = feature.properties;\r\n\t\t\t\tvar x = properties.SAMPLE_LONGITUDE;\r\n\t\t\t\tvar y = properties.SAMPLE_ELEVATION;\r\n\t\t\t\tvar z = properties.SAMPLE_LATITUDE\r\n\t\t\t\t\r\n\t\t\t\tvar d = {\r\n\t\t\t\t\tx : typeof x != \"undefined\"?x:feature.geometry.coordinates[0],\r\n\t\t\t\t\ty : typeof y != \"undefined\"?y:feature.geometry.coordinates[2],\r\n\t\t\t\t\tz : typeof z != \"undefined\"?z:feature.geometry.coordinates[1]\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\td.y = d.y ? d.y : 0;\r\n\t\t\t\tunfiltered[i] = {\r\n\t\t\t\t\tx : +d.x,\r\n\t\t\t\t\ty : +d.y,\r\n\t\t\t\t\tz : +d.z\r\n\t\t\t\t};\r\n\t\t\t});\r\n\r\n\t\t\tvar xExtent = tile.extent.x;\r\n\t\t\tvar yExtent = d3.extent(unfiltered, function(d: any) {\r\n\t\t\t\treturn d.y;\r\n\t\t\t});\r\n\t\t\tvar zExtent = tile.extent.y;\r\n\r\n\t\t\tyExtent = [\r\n\t\t\t    Math.min(yExtent[0]?yExtent[0]:0, heightExtent[0]),\r\n\t\t\t    Math.max(yExtent[1]?yExtent[1]:0, heightExtent[1])\r\n\t\t\t];\r\n\t\t\t\r\n\t\t\tvar vpts: any = data.extents = {\r\n\t\t\t\txMax : xExtent[1],\r\n\t\t\t\txCen : (xExtent[1] + xExtent[0]) / 2,\r\n\t\t\t\txMin : xExtent[0],\r\n\t\t\t\tyMax : yExtent[1],\r\n\t\t\t\tyCen : (yExtent[1] + yExtent[0]) / 2,\r\n\t\t\t\tyMin : yExtent[0],\r\n\t\t\t\tzMax : zExtent[1],\r\n\t\t\t\tzCen : (zExtent[1] + zExtent[0]) / 2,\r\n\t\t\t\tzMin : zExtent[0],\r\n\t\t\t\taspectRatio: Math.cos(Math.PI/180 * (zExtent[1] + zExtent[0]) / 2)\r\n\t\t\t};\r\n\t\t\tvpts.length = (vpts.zMax - vpts.zMin) * LENGTH_DEGREE; // Just a rough enough guess for what we want.\r\n\t\t\tvpts.width = vpts.length * vpts.aspectRatio;\r\n\t\t\tvpts.height = vpts.yMax - vpts.yMin;\r\n\t\t\t\r\n\t\t\tvar colour = d3.scale.category20c();\r\n\r\n\t\t\tstate.scale = {\r\n\t\t\t\tx: d3.scale.linear().domain(xExtent).range([ -50, 50 ]),\r\n\t\t\t\ty: d3.scale.linear().domain(yExtent).range([ -50, 50 ]),\r\n\t\t\t\tz: d3.scale.linear().domain(zExtent).range([ 50, -50 ])\r\n\t\t\t};\r\n\t\t\r\n\t\t\tvar lineGeo = getLineGeo(vpts, state.scale);\r\n\t\t\tvar lineMat = new THREE.LineBasicMaterial({\r\n\t\t\t\tcolor : 0x000000\r\n\t\t\t});\r\n\t\t\tlineMat.transparent = true;\r\n\t\t\tlineMat.opacity = 0.3;\r\n\t\t\tvar line = new THREE.Line(lineGeo, lineMat);\r\n\t\t\tscatterPlot.add(line);\r\n\t\t\r\n\t\t\tvar titleX = createText2D('-X');\r\n\t\t\ttitleX.position.x = state.scale.x(vpts.xMin) - 12, titleX.position.y = 5;\r\n\t\t\tscatterPlot.add(titleX);\r\n\t\t\r\n\t\t\tvar valueX = createText2D(format(xExtent[0]));\r\n\t\t\tvalueX.position.x = state.scale.x(vpts.xMin) - 12, valueX.position.y = -5;\r\n\t\t\tscatterPlot.add(valueX);\r\n\t\t\r\n\t\t\tvar titleX = createText2D('X');\r\n\t\t\ttitleX.position.x = state.scale.x(vpts.xMax) + 12;\r\n\t\t\ttitleX.position.y = 5;\r\n\t\t\tscatterPlot.add(titleX);\r\n\t\t\r\n\t\t\tvar valueX = createText2D(format(xExtent[1]));\r\n\t\t\tvalueX.position.x = state.scale.x(vpts.xMax) + 12, valueX.position.y = -5;\r\n\t\t\tscatterPlot.add(valueX);\r\n\t\t\r\n\t\t\tvar titleY = createText2D('-Z');\r\n\t\t\ttitleY.position.y = state.scale.y(vpts.yMin) - 5;\r\n\t\t\tscatterPlot.add(titleY);\r\n\t\t\r\n\t\t\tvar valueY = createText2D(format(yExtent[0]));\r\n\t\t\tvalueY.position.y = state.scale.y(vpts.yMin) - 15, scatterPlot.add(valueY);\r\n\r\n\t\t\tvar titleY = createText2D('Z');\r\n\t\t\ttitleY.position.y = state.scale.y(vpts.yMax) + 30;\r\n\t\t\tscatterPlot.add(titleY);\r\n\t\t\r\n\t\t\tvar valueY = createText2D(format(yExtent[1]));\r\n\t\t\tvalueY.position.y = state.scale.y(vpts.yMax) + 20, scatterPlot.add(valueY);\r\n\t\t\r\n\t\t\tvar titleZ = createText2D('-Y ' + format(zExtent[0]));\r\n\t\t\ttitleZ.position.z = state.scale.z(vpts.zMin) + 2;\r\n\t\t\tscatterPlot.add(titleZ);\r\n\t\t\r\n\t\t\tvar titleZ = createText2D('Y ' + format(zExtent[1]));\r\n\t\t\ttitleZ.position.z = state.scale.z(vpts.zMax) + 2;\r\n\t\t\tscatterPlot.add(titleZ);\r\n\t\t\r\n\t\t\tvar mat = new THREE.PointsMaterial({\r\n\t\t\t\tvertexColors : THREE.VertexColors,\r\n\t\t\t\tsize : 10\r\n\t\t\t});\r\n\r\n\t\t\tvar pointCount = unfiltered.length;\r\n\t\t\tobjects = [];\r\n\t\t\tvar pointGeo = new THREE.Geometry();\r\n\t\t\tfor (var i = 0; i < pointCount; i++) {\r\n\t\t\t\tvar x = state.scale.x(unfiltered[i].x);\r\n\t\t\t\tvar y = state.scale.y(unfiltered[i].y);\r\n\t\t\t\tvar z = state.scale.z(unfiltered[i].z);\r\n\t\t\t\tvar p = new THREE.Vector3(x, y, z);\r\n\t\t\t\tobjects.push(p);\r\n\t\t\t\tpointGeo.vertices.push(p);\r\n\t\t\t\t\r\n\t\t\t\tpointGeo.colors.push(new THREE.Color().setRGB(\r\n\t\t\t\t\t\thexToRgb(colour(\"\"+i)).r / 255, hexToRgb(colour(\"\"+i)).g / 255,\r\n\t\t\t\t\t\thexToRgb(colour(\"\"+i)).b / 255));\r\n\t\t\r\n\t\t\t}\r\n\t\t\tif(pointCount > 0) {\r\n\t\t\t\tpointGeo.computeBoundingSphere();\r\n\t\t\t\tif(pointGeo.boundingSphere.radius < 5) {\r\n\t\t\t\t\tconsole.log(\"Overriding bounding sphere radius\" + pointGeo.boundingSphere.radius);\r\n\t\t\t\t\tpointGeo.boundingSphere.radius = 5;\r\n\t\t\t\t}\r\n\t\t\t} \r\n\t\t\tvar points = objects = new THREE.Points(pointGeo, mat);\r\n\t\t\tscatterPlot.add(points);\r\n\r\n\t\t\tstate.renderer.render(state.scene, state.camera);\r\n\r\n\t\t\tdata.loaded = d;\r\n\t\t\tscatterPlot.scale.x = scatterPlot.scale.x * vpts.aspectRatio;\r\n\t\t\trocks3dSurfaceService.render(data, state);\t\t\t\r\n\t\t\t\r\n\t\t\tvar last = new Date().getTime();\r\n\t\t\tvar down = false;\r\n\t\t\tvar sx = 0, sy = 0;\r\n\t\t\r\n\t\t\tstate.renderer.domElement.onmousedown = function(ev: MouseEvent) {\r\n\t\t\t\tvar rect = state.renderer.domElement.getBoundingClientRect();\r\n\t\t\t\tdown = true;\r\n\t\t\t\tsx = ev.clientX;\r\n\t\t\t\tsy = ev.clientY;\r\n\t\t\t\tvar mouse = new THREE.Vector2();\r\n\r\n\t\t\t\tmouse.x = ( (ev.clientX - rect.left) / state.renderer.domElement.clientWidth ) * 2 - 1;\r\n\t\t\t\tmouse.y = - ( (ev.clientY - rect.top) / state.renderer.domElement.clientHeight ) * 2 + 1;\r\n\r\n\t\t\t\t$rootScope.$broadcast(config.rendererSelectEventName, mouse);\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tstate.renderer.domElement.onmouseup = function() {\r\n\t\t\t\tdown = false;\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tvar raycaster = new THREE.Raycaster();\r\n\t\t\t\r\n\t\t\tstate.renderer.domElement.onmousemove = function( event: MouseEvent) {\r\n\t\t\t\tvar feature: any;\r\n\t\t\t\tvar rect = state.renderer.domElement.getBoundingClientRect();\r\n\t\t\t\tvar mouse = new THREE.Vector2();\r\n\t\t\t\tevent.preventDefault();\r\n\r\n\t\t\t\tmouse.x = ( (event.clientX - rect.left) / state.renderer.domElement.clientWidth ) * 2 - 1;\r\n\t\t\t\tmouse.y = - ( (event.clientY - rect.top) / state.renderer.domElement.clientHeight ) * 2 + 1;\r\n\r\n\t\t\t\traycaster.setFromCamera( mouse, state.camera );\r\n\r\n\t\t\t\tvar intersects = raycaster.intersectObject( points, true );\r\n\r\n\t\t\t\tif ( intersects.length > 0 ) {\r\n\t\t\t\t\tfeature = d.features[intersects[0].index];\r\n\t\t\t\t\t$rootScope.$broadcast(config.onhoverEventName, decorateHtml(feature));\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tfunction decorateHtml(feature: GeoJSON.Feature) {\r\n\t\t\t\t\tvar html: string, br: string;\r\n\t\t\t\t\tvar properties = feature.properties;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(properties && !properties.html) {\r\n\t\t\t\t\t\thtml = \"<div class='popup-header'><strong>ID: </strong><a class='title-link' target='_blank' href='\" +\r\n\t\t\t\t\t\tconfig.dataUrl.replace(\"{id}\", feature.id) + \"'>\" + feature.id + \"</a></div>Lon/lat elev: \" +\r\n\t\t\t\t\t\t\tfeature.geometry.coordinates[0].toFixed(6) + \"/\" + \r\n\t\t\t\t\t\t\tfeature.geometry.coordinates[1].toFixed(6) + \r\n\t\t\t\t\t\t\t\" \" + (typeof feature.geometry.coordinates[2] == \"undefined\"?\"-\":feature.geometry.coordinates[2]);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tbr = \"<br/>\";\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tfor (var property in properties) {\r\n\t\t\t\t\t\t    if (properties.hasOwnProperty(property)) {\r\n\t\t\t\t\t\t        html += br + property + \"<br/>&#160;\" + properties[property];\r\n\t\t\t\t\t\t    }\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tproperties.html = html;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn feature;\r\n\t\t\t\t}\r\n\t\t    }\r\n\t\t\t// Get the loop going. \r\n\t\t\tvar controls = new THREE.OrbitControls( state.camera, state.renderer.domElement );\r\n\t\t\t\r\n\t\t\tanimate();\r\n\t\t\tfunction animate() {\r\n\t\t\t\twindow.requestAnimationFrame(animate);\r\n\t\t\t\t\r\n\t\t\t\tstate.renderer.clear();\r\n\t\t\t\tstate.camera.lookAt(state.scene.position);\r\n\t\t\t\tstate.renderer.render(state.scene, state.camera);\r\n\t\t\t\tcontrols.update();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t\r\n\tfunction getLineGeo(vpts: any, scale: any) {\r\n\t\tvar xScale = scale.x; \r\n\t\tvar yScale = scale.y;\r\n\t\tvar zScale = scale.z;\r\n\t\t\r\n\t\tvar lineGeo = new THREE.Geometry();\r\n\t\tlineGeo.vertices.push(\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMax), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMax), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMin), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMin), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMax), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMin), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMin), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMax), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMax), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMin), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMin), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yCen), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yCen), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yCen), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yCen), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yCen), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yCen), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yCen), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMin), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMax), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMax), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMax), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yCen), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xCen), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMax), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMax), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yCen), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yCen), zScale(vpts.zCen)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yCen), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMin), zScale(vpts.zMax)),\r\n\t\t    v(xScale(vpts.xMin), yScale(vpts.yMin), zScale(vpts.zMin)),\r\n\t\t    v(xScale(vpts.xMax), yScale(vpts.yMin), zScale(vpts.zMin))\r\n\t\t);\r\n\t\treturn lineGeo;\r\n\t}\r\n\r\n\tfunction v(x: number, y: number, z: number) {\r\n\t\treturn new THREE.Vector3(x, y, z);\r\n\t}\r\n\r\n\tfunction createTextCanvas(text: any, color?: any, font?: any, size?: any) {\r\n\t\tsize = size || 16;\r\n\t\tvar canvas = document.createElement('canvas');\r\n\t\tvar ctx = canvas.getContext('2d');\r\n\t\tvar fontStr = (size + 'px ') + (font || 'Arial');\r\n\t\tctx.font = fontStr;\r\n\t\tvar w = ctx.measureText(text).width;\r\n\t\tvar h = Math.ceil(size);\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tctx.font = fontStr;\r\n\t\tctx.fillStyle = color || 'black';\r\n\t\tctx.fillText(text, 0, Math.ceil(size * 0.8));\r\n\t\treturn canvas;\r\n\t}\r\n\r\n\tfunction createText2D(text: any, color?: any, font?: any, size?: any, segW?: any, segH?: any) {\r\n\t\tvar canvas = createTextCanvas(text, color, font, size);\r\n\t\tvar plane = new THREE.PlaneGeometry(canvas.width, canvas.height, segW, segH);\r\n\t\tvar tex = new THREE.Texture(canvas);\r\n\t\ttex.needsUpdate = true;\r\n\t\tvar planeMat = new THREE.MeshBasicMaterial({\r\n\t\t\tmap : tex,\r\n\t\t\tcolor : 0xffffff,\r\n\t\t\ttransparent : true\r\n\t\t});\r\n\t\tvar mesh = new THREE.Mesh(plane, planeMat);\r\n\t\tmesh.scale.set(0.5, 0.5, 0.5);\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\t// from http://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb\r\n\tfunction hexToRgb(hex: any) { // TODO rewrite with vector output\r\n\t\tvar result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n\t\treturn result ? {\r\n\t\t\tr : parseInt(result[1], 16),\r\n\t\t\tg : parseInt(result[2], 16),\r\n\t\t\tb : parseInt(result[3], 16)\r\n\t\t} : null;\r\n\t}\r\n\t\r\n\tfunction bootstrap() {\t\t\r\n\t\tvar search = $location.search();\r\n\t\tvar setter = conditional(search);\r\n\t\t// The function setter returns itself so you can call ad infinitum\r\n\t\tsetter('x')('y')('zoom')('hash')('filter');\r\n\t\t\r\n\t\t\r\n\t\t// Set up some helper functions\r\n\t\tconfig.createTileInfo = function() {\r\n\t\t\tif(this.hash) {\r\n\t\t\t\treturn this.url + \"tileInfo\" + (this.hash.indexOf(\"/\") != 0?\"/\":\"\") + this.hash;\r\n\t\t\t}\r\n\t\t\treturn this.url + \"tileInfo?\" + this.createPointParameters();\r\n\t\t};\r\n\t\t\r\n\t\tconfig.createFeatures = function() {\r\n\t\t\treturn this.url + \"features\" + this.createParameters();\r\n\t\t};\r\n\t\t\r\n\t\tconfig.createParameters = function() {\r\n\t\t\tif(this.hash) {\r\n\t\t\t\treturn \"/\" + this.hash + \"?maxCount=\" + this.maxCount + createFilters(this.filter).join(\"\");\r\n\t\t\t}\r\n\t\t\treturn \"?\" + this.createPointParameters() + \"&maxCount=\" + this.maxCount + createFilters(this.filter).join(\"\");\r\n\t\t}\r\n\t\t\r\n\t\tconfig.createPointParameters = function() {\r\n\t\t\treturn \"x=\" + this.x +\r\n\t\t\t\t\"&y=\" + this.y + \r\n\t\t\t\t\"&zoom=\" + this.zoom;\r\n\t\t};\r\n\t\t\r\n\t\tconfig.setHash = function(xyzoom: any) {\r\n\t\t\tthis.hash = xyzoom.zoom + \"/\" + xyzoom.x + \"/\" + xyzoom.y;\r\n\t\t};\r\n\t\t\r\n\t\tconfig.getHash = function() {\r\n\t\t\tvar index = 0;\r\n\t\t\tvar parts = this.hash.split(\"/\");\r\n\t\t\tif(parts.length == 4) {\r\n\t\t\t\tindex = 1;\r\n\t\t\t}\r\n\t\t\treturn {\r\n\t\t\t\tzoom: parseInt(parts[index++]),\r\n\t\t\t\tx: parseFloat(parts[index++]),\r\n\t\t\t\ty: parseFloat(parts[index])\r\n\t\t\t};\t\t\r\n\t\t};\r\n\t\t\r\n\t\tfunction createFilters(filterArr: any) {\r\n\t\t\tvar filters: any[] = [];\r\n\r\n\t\t\tif(filterArr) {\r\n\t\t\t\tif(angular.isArray(filterArr)) {\r\n\t\t\t\t\tfilters = filterArr.map(function(filter: any) {\r\n\t\t\t\t\t\treturn \"&filter=\" + encodeURIComponent(filter);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfilters = [\"&filter=\" + encodeURIComponent(filterArr)]; \r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}\r\n\t\t\treturn filters;\r\n\t\t}\r\n\t\t\r\n\t\tfunction conditional(search: any) {\r\n\t\t\tvar set: Function = function set(key: string) {\r\n\t\t\t\tvar value = search[key];\r\n\t\t\t\tif(typeof value != \"undefined\") {\r\n\t\t\t\t\tconfig[key] = value;\r\n\t\t\t\t}\r\n\t\t\t\treturn set;\r\n\t\t\t};\r\n\t\t\treturn set;\r\n\t\t}\r\n\t}\r\n}]);\r\n\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n/// <reference path=\"../config/config.ts\" />\r\n\r\n'use strict';\r\n\r\nmodule rocks3d.multisurface {\r\n'use strict';\r\n\r\nangular.module('rocks3d.multisurface', [])\r\n\r\n.directive(\"rocks3dSurface\", ['rocks3dSurfaceService', function(rocks3dSurfaceService: any) {\r\n\treturn {\r\n\t\tlink: function(scope: ng.IScope) {\r\n\t\t\t//rocks3dSurfaceService.prime();\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.provider('rocks3dSurfaceService', [function() {\t\r\n\tvar metadataLocation = \"rocks3d/resources/config/surfaces.json\";\r\n\tvar metadata: any = null;\r\n\t\r\n\tthis.location = function(url: string) {\r\n\t\tmetadataLocation = url;\r\n\t}\t\r\n\t\r\n\tvar METRES_PER_DEGREE = 111000;\r\n\tvar geometry: any, plane: any;\r\n\tvar lastData: any;\r\n\tvar state: any = {};\r\n\tvar heightData: number[];\r\n\tvar tileInfo: any;\r\n\tvar sceneProperties: any;\r\n\tvar waiters: ng.IDeferred<any>[] = null;\r\n\t\r\n\t\r\n\tthis.$get = ['$http', '$q', '$rootScope', '$timeout', 'configService', \r\n\t\t\tfunction($http: ng.IHttpService, $q: ng.IQService, $rootScope: ng.IRootScopeService, $timeout: ng.ITimeoutService, configService: rocks3d.config.IConfigService) {\t\t\r\n\t\tvar service: any = {};\r\n\t\tvar config = configService.getConfig(\"surface\");\r\n\t\t\r\n\t\tservice.getMetadata = function() {\r\n\t\t\tif(metadata) {\r\n\t\t\t\treturn $q.when(metadata);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tvar deferred = $q.defer();\r\n\t\t\tif(!waiters) {\r\n\t\t\t\twaiters = [deferred];\r\n\t\t\t\t$http.get(metadataLocation, {cache: true}).then(function(response) {\r\n\t\t\t\t\tmetadata = response.data;\r\n\t\t\t\t\twaiters.forEach(function(waiter) {\r\n\t\t\t\t\t\twaiter.resolve(metadata);\r\n\t\t\t\t\t});\t\t\t\t\t\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\twaiters.push(deferred);\r\n\t\t\t}\r\n\t\t\treturn deferred.promise;\r\n\t\t};\r\n\r\n\t\tservice.data = function() {\r\n\t\t\treturn state;\r\n\t\t};\r\n\t\t\r\n\t\tservice.prime = function(tile: any) {\r\n\t\t\tvar deferred = $q.defer();\r\n\t\t\t\r\n\t\t\tvar planes: any[] = [];\r\n\t\t\tservice.getMetadata().then(function(metadata: any) {\r\n\t\t\t\tvar t = tile;\r\n\t\t\t\tmetadata.features.forEach(function(item: any) {\r\n\t\t\t\t\tvar urls = item.properties.urlTemplates;\r\n\t\t\t\t\tif(item.properties.show) {\r\n\t\t\t\t\t\tvar loader = new THREE.DataSurfaceLoader();\r\n\t\t\t\t\t\tloader.load(\r\n\t\t\t\t\t\t\ttransformUrl(urls.elevation, tile, config.resolution),\r\n\t\t\t\t\t\t\ttransformUrl(urls.imagery, tile, config.resolution),\r\n\t\t\t\t\t\t\tloaded\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t});\r\n\t\t\treturn deferred.promise;\r\n\t\t\t\r\n\t\t\tfunction loaded(data: any) {\r\n\t\t\t\tconsole.log(\"Tadah!\");\r\n\t\t\t\tconsole.log(data);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t};\r\n\t\t\r\n\t\t\r\n\t\treturn service;\r\n\t}];\r\n}]);\r\n\r\nfunction transformUrl(url: string, tile: any, resolution: number) {\r\n\treturn url.replace(/\\{resolution\\}/g, \"\"+resolution).replace(\"{bbox}\", tile.bbox);\r\n}\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n/// <reference path=\"../config/config.ts\" />\r\n\r\nmodule rocks3d.surface {\r\n'use strict';\t\r\n\r\n\r\nangular.module('rocks3d.surface', [])\r\n\r\n.directive(\"rocks3dSurface\", ['rocks3dSurfaceService', function(rocks3dSurfaceService: any) {\r\n\treturn {\r\n\t\tlink: function(scope: ng.IScope) {\r\n\t\t\t//rocks3dSurfaceService.prime();\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.factory('rocks3dSurfaceService', ['$q', '$rootScope', '$timeout', 'configService',  \r\n                function($q: ng. IQService, $rootScope: ng.IRootScopeService, $timeout: ng.ITimeoutService, configService: rocks3d.config.IConfigService) {\r\n\t\r\n\tvar METRES_PER_DEGREE = 111000;\r\n\tvar service: any = {};\r\n\tvar geometry: THREE.Geometry, plane: any;\r\n\tvar lastData: any;\r\n\tvar config = configService.getConfig(\"surface\");\r\n\tvar state: any = {};\r\n\tvar heightData: number[];\r\n\tvar tileInfo: any;\r\n\tvar sceneProperties: any;\r\n\t\r\n\tservice.data = function() {\r\n\t\treturn state;\r\n\t};\r\n\t\r\n\tservice.prime = function(tile: any) {\r\n\t\ttileInfo = tile;\r\n\t\tvar deferred = $q.defer();\r\n\r\n\t\tvar wcs1sec = config.elevation1SecUrl;\t\r\n\t\twcs1sec = wcs1sec.replace(/\\{resolution\\}/g, config.resolution);\r\n\t\twcs1sec = wcs1sec.replace(\"{bbox}\", tile.bbox);\r\n\t\t\r\n\t\tvar terrainLoader = new THREE.GeotiffTerrainLoader();\t\r\n\t\tterrainLoader.load(wcs1sec, function(loaded: number[]) {\r\n\t\t\theightData = loaded;\r\n\t\t\tdeferred.resolve(loaded);\r\n\t\t});\r\n\t\treturn deferred.promise;\r\n\t};\r\n\t\r\n\tservice.checkElevation = function(xy: any) {\r\n\t\tvar raycaster = new THREE.Raycaster();\r\n\t\tvar state = sceneProperties;\r\n\t\traycaster.setFromCamera( xy, state.camera );\r\n\t\tvar intersects = raycaster.intersectObject( plane, true );\r\n\t\t\r\n\t\tif ( intersects.length > 0 ) {\r\n\t\t\tconsole.log(\"Intersects\");\r\n\t\t\tconsole.log(plane);\r\n\t\t\tconsole.log(intersects[0]);\r\n\t\t}\r\n\t};\r\n\t\r\n\tservice.render = function(data: any, properties:any): any {\r\n\t\tsceneProperties = properties;\r\n\t\tlastData = data;\r\n\t\tvar loaded = data.loaded;\r\n\t\tvar yCen = data.extents.yCen;\r\n\t\t\r\n\t\tif(tileInfo.properties.hash.z < 4) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tvar bbox = toBbox(tileInfo.bbox);\r\n\t\t\r\n\t\tvar baseUrl = config.imageryUrls.national.url;\r\n\t\t\r\n\t\t//Lets see if we can use the NSW imagery.\r\n\t\tvar extents = data.extents;\r\n\t\tvar nswExtent = config.imageryUrls.nsw.extent;\r\n\t\tif(extents.xMin > nswExtent.xmin && extents.xMax < nswExtent.xmax  &&\r\n\t\t\t\textents.zMin > nswExtent.ymin && extents.zMax < nswExtent.ymax) {\r\n\t\t\tbaseUrl = config.imageryUrls.nsw.url;\r\n\t\t}\r\n\t    \r\n\t    var loader = new THREE.TextureLoader();\r\n\t    loader.crossOrigin = '';\r\n\t    var material = new THREE.MeshPhongMaterial({\r\n            map: loader.load(baseUrl.replace(\"{bbox}\", bbox)),\r\n            transparent:true,\r\n            opacity:config.surfaceOpacity\r\n        });\r\n\t    \r\n\t    $timeout(function() { state.surface = material; });\r\n\t    \r\n\t    geometry = new THREE.PlaneGeometry(100, 100, 199, 199);\r\n\r\n\t    plane = new THREE.Mesh(geometry, material);\r\n\t\t    \r\n\t    plane.rotation.x = -Math.PI / 2;\r\n\t\t    \r\n\t    geometry.vertices.forEach(function(vertice, i) {\r\n\t        vertice.z = sceneProperties.scale.y(heightData[i]);\r\n\t    });\r\n\t    geometry.computeFaceNormals();\r\n\t    geometry.computeVertexNormals();\r\n\t    //plane.scale.z = 1/10; //-heightCalc(1);\r\n\t    sceneProperties.container.add(plane);\r\n\t    \r\n\t    return {\r\n\t    \tplane: plane\t    \t\r\n\t    };\r\n\t};\r\n\t\r\n\treturn service;\r\n\t\r\n\tfunction matchPoints(tileInfo: any) {\r\n\t\tvar z = tileInfo.properties.hash.z;\r\n\t\tvar extentX = tileInfo.extent.x;\r\n\t\tvar result = 80/((extentX[1] - extentX[0]) * METRES_PER_DEGREE) +\r\n\t\t\t\t\t\t(10 - z) * 0.001;\r\n\t\treturn result;\r\n\t}\r\n\r\n\tfunction toBbox(bboxArr: number[]) {\r\n\t\treturn bboxArr[0] + \",\" +\r\n\t\tbboxArr[1] + \",\" +\r\n\t\tbboxArr[2] + \",\" +\r\n\t\tbboxArr[3];\r\n\t}\r\n}]);\r\n\r\n\r\n}","/// <reference path=\"../../../../typings/tsd.d.ts\" />\r\n\r\nmodule rocks3d.view {\r\n'use strict';\t\r\n\r\ninterface VerticalExagerateScope extends ng.IScope {\r\n\tindex: number;\r\n\trange: any;\r\n\tsmaller: Function;\r\n\tlarger: Function;\r\n\toneToOne: Function;\r\n}\r\n\r\ninterface SurfaceOpacityScope extends ng.IScope {\r\n\tdata: any;\r\n}\r\n\r\nangular.module('rocks3d.view', [])\r\n\r\n.directive(\"rocks3dView\", [function() {\r\n\treturn {\r\n\t\ttemplateUrl: \"rocks3d/view/view.html\"\r\n\t};\r\n}])\r\n\t\r\n.directive(\"rocks3dSurfaceOpacity\", [function() {\r\n\treturn {\r\n\t\ttemplateUrl: \"rocks3d/view/surfaceopacity.html\",\r\n\t\tlink: function(scope: ng.IScope, element: ng.IAugmentedJQuery) {}\r\n\t};\r\n}])\r\n\t\r\n.directive(\"rocks3dVerticalExaggerate\", ['rocks3dParticlesService', function(rocks3dParticlesService: any) {\t\r\n\tvar range = [0.0001, 0.0002, 0.0005, 0.001, 0.002, 0.005, 0.01, 0.02, 0.05, \r\n\t             0.1, 0.2, 0.5, 1];\r\n\treturn {\r\n\t\ttemplateUrl: 'rocks3d/view/verticalexaggerate.html',\r\n\t\tscope: {\r\n\t\t\tdirection: \"=\"\r\n\t\t},\r\n\t\tlink: function(scope: VerticalExagerateScope, element: ng.IAugmentedJQuery) {\r\n\t\t\tscope.index = 12;\r\n\t\t\tscope.range = range;\r\n\t\t\tscope.smaller = function() {\r\n\t\t\t\tscope.index--;\r\n\t\t\t\tchange();\r\n\t\t\t};\r\n\t\t\tscope.larger = function() {\r\n\t\t\t\tscope.index++;\r\n\t\t\t\tchange();\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tscope.oneToOne = function() {\r\n\t\t\t\tvar props = rocks3dParticlesService.scene();\r\n\t\t\t\tvar dimensions = props.data.extents;\r\n\t\t\t\tvar length = dimensions.length;\r\n\t\t\t\tvar height = dimensions.height;\r\n\t\t\t\tvar ratio = height/length;\r\n\t\t\t\tprops.container.scale.y = ratio;\r\n\t\t\t\t\r\n\t\t\t};\r\n\t\t\t\r\n\t\t\tfunction change() {\r\n\t\t\t\tvar props = rocks3dParticlesService.scene();\r\n\t\t\t\tvar scale = props.container.scale;\r\n\t\t\t\tscale.y = range[scope.index];\r\n\t\t\t\tscale.z = 1 - (scope.index - 12) * 0.1;\r\n\t\t\t\tscale.x = props.data.extents.aspectRatio * (1 - (scope.index - 12) * 0.1);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n}])\r\n\r\n.directive(\"rocks3dSurfaceOpacity\", ['rocks3dSurfaceService', function(rocks3dSurfaceService: any) {\r\n\treturn {\r\n\t\tlink: function(scope: SurfaceOpacityScope) {\r\n\t\t\tscope.data = rocks3dSurfaceService.data();\r\n\t\t}\r\n\t};\r\n}]);\r\n\r\n}",null],"sourceRoot":"/source/"}