"use strict";var rocks3dApp;!function(e){angular.module("Rocks3dApp",["rocks3d.cluster","rocks3d.config","rocks3d.map","rocks3d.message","rocks3d.multisurface","rocks3d.navigator","rocks3d.particles","rocks3d.templates","rocks3d.view"]).config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}])}(rocks3dApp||(rocks3dApp={}));var rocks3d;!function(e){var r;!function(e){var r={};r.surface={resolution:200,elevation1SecUrl_delayed:"http://services.ga.gov.au/gis/services/DEM_SRTM_1Second_Hydro_Enforced/MapServer/WCSServer?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326&BBOX={bbox}&FORMAT=GeoTIFF&RESX={resolution}&RESY={resolution}&RESPONSE_CRS=EPSG:4326&HEIGHT={resolution}&WIDTH={resolution}",elevation1SecUrl:"/arcgis/services/Great_Artesian_Basin_groundwater/MapServer/WCSServer?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326&BBOX={bbox}&FORMAT=GeoTIFF&RESX={resolution}&RESY={resolution}&RESPONSE_CRS=EPSG:4326&HEIGHT={resolution}&WIDTH={resolution}",elevationBandannaUrl:"http://win-amap-test01:6080/arcgis/services/Bandanna_Top_Galilee_groundwater/MapServer/WCSServer?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326&BBOX={bbox}&FORMAT=GeoTIFF&RESX={resolution}&RESY={resolution}&RESPONSE_CRS=EPSG:4326&HEIGHT={resolution}&WIDTH={resolution}",elevation1SecSmoothedUrl:"http://www.ga.gov.au/gisimg/services/topography/dem_s_1s/ImageServer/WCSServer?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326&BBOX={bbox}&FORMAT=GeoTIFF&RESX={resolution}&RESY={resolution}&RESPONSE_CRS=EPSG:4326&HEIGHT={resolution}&WIDTH={resolution}",elevation5MUrl:"http://services.ga.gov.au/gis/services/DEM_LiDAR_5m/MapServer/WCSServer?SERVICE=WCS&VERSION=1.0.0&REQUEST=GetCoverage&coverage=1&CRS=EPSG:4326&BBOX={bbox}&FORMAT=GeoTIFF&RESX={resolution}&RESY={resolution}&RESPONSE_CRS=EPSG:4326&HEIGHT={resolution}&WIDTH={resolution}",imageryUrls:{national:{url:"http://win-amap-test01:6080/arcgis/services/Great_Artesian_Basin_groundwater/MapServer/WMSServer?LAYERS=0&TRANSPARENT=TRUE&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=&FORMAT=image%2Fpng&SRS=EPSG%3A4326&BBOX={bbox}&WIDTH=512&HEIGHT=512"},nsw:{url:"http://maps.six.nsw.gov.au/arcgis/services/public/NSW_Imagery/MapServer/WMSServer?LAYERS=BestImageryDates&TRANSPARENT=TRUE&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=&FORMAT=image%2Fpng&SRS=EPSG%3A4326&BBOX={bbox}&WIDTH=512&HEIGHT=512",extent:{xmin:141,xmax:151.3,ymin:-35,ymax:-28.5}}},surfaceOpacity:.1,listenDataLoadedEventName:"rocks3ddataloaded",listenRendererSelectEventName:"rocks3donselected"},r.mapConfig={options:{maxBounds:[[-48,106],[-6,159]],center:[-28,135],minZoom:4,zoom:5},position:{bounds:[[-44,117],[-12,146]],minZoom:13},layer:{name:"Google Hybrid",type:"Google",parameters:["HYBRID"],defaultLayer:!0,isBaselayer:!0,visible:!0},listenForExtentEvent:"rocks3ddrawpolygon",listenForMarkerEvent:"rocks3ddrawmarker"},r.particles={dataUrl:"http://www.ga.gov.au/geophysics-rockpropertypub-gws/ga_rock_properties_wfs/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=ga_rock_properties_wfs:remanent_magnetisation,ga_rock_properties_wfs:scalar_results&maxFeatures=50&outputFormat=application%2Fgml%2Bxml%3B+version%3D3.2&featureID={id}",url:"service/tile/",x:138,y:-28,zoom:4,maxCount:3e5,onhoverEventName:"rocks3ddrawmarker",dataLoadedEventName:"rocks3ddataloaded",rendererSelectEventName:"rocks3donselected"},r.scene={camera:{z:200,x:-100,y:100},light:{position:{x:100,y:500,z:0}},onloadEventName:"rocks3ddrawpolygon"},angular.module("rocks3d.config",[]).factory("configService",[function(){return{getConfig:function(e){return e?r[e]:r}}}])}(r=e.config||(e.config={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.cluster",[]).directive("rocks3dCluster",["rocks3dClusterService",function(e){return{link:function(r){e.init()}}}]).factory("rocks3dClusterService",["$http","rocks3dMapService","rocks3dNavigatorService",function(e,r,n){var t,o="service/rocks/summary",a=0,i={};return i.init=function(){r.getMap().then(function(r){function i(i){t&&(r.removeLayer(t),t=null);var c=++a,s=r.getZoom(),u=r.getBounds(),d=[];d.push("xmin="+Math.max(u.getWest()-20/s,-180)),+d.push("xmax="+Math.min(u.getEast()+20/s,180)),d.push("ymin="+Math.max(u.getSouth()-10/s,-90)),d.push("ymax="+Math.min(u.getNorth()+10/s,90)),d.push("zoom="+Math.max(s,2));e.get(o+"?"+d.join("&")).then(function(e){if(!(a>c)){var o=Math.sqrt(d3.max(e.data.features,function(e){return e.properties.count}));t=L.geoJson(e.data,{pointToLayer:function(e,r){var t={radius:4+20/o*Math.sqrt(e.properties.count),fillColor:"#ff7800",color:"#000",weight:1,opacity:1,fillOpacity:.8},a=L.circleMarker(r,t).bindLabel(""+e.properties.count,{noHide:!0});return a.on("click",function(){var e=this.feature.id.split("/");n.to({zoom:e[0],x:e[1],y:e[2]})}),a}}).addTo(r)}})}r.on("zoomend",i),r.on("dragend",i)})},i}])}(r=e.cluster||(e.cluster={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.map",[]).directive("rocks3dMap",["rocks3dMapService",function(e){return{restrict:"AE",link:function(r,n,t){e.createMap(t.id)}}}]).factory("rocks3dMapService",["$document","$q","$rootScope","configService",function(e,r,n,t){function o(e,r){var n=a(e);r.addLayer(n)}function a(e){var r=[];return angular.isArray(e.type)?(r=L,e.type.forEach(function(e){r=r[e]})):r=L[e.type],e.parameters&&e.parameters.length>0?new r(e.parameters[0],e.parameters[1],e.parameters[2],e.parameters[3],e.parameters[4]):new r}var i,c,s,u={},d=t.getConfig("mapConfig"),l=[];return u.getMap=function(){var e;return i?r.when(i):(e=r.defer(),l.push(e),e.promise)},u.createMap=function(e){function r(e){var r;r="undefined"!=typeof e.properties.SAMPLE_LONGITUDE?{type:"Point",coordinates:[e.properties.SAMPLE_LONGITUDE,e.properties.SAMPLE_LATITUDE]}:e.geometry,s&&i.removeLayer(s),s=L.geoJson({type:"Feature",geometry:r,id:e.id}).addTo(i),e.properties.html&&s.bindPopup(e.properties.html).openPopup()}function t(e){c&&i.removeLayer(c),c=L.geoJson(e).addTo(i),i.fitBounds(c.getBounds(),{animate:!0,padding:L.point(100,100)})}i=new L.Map(e,{center:d.options.center,zoom:d.options.zoom}),o(d.layer,i),L.control.scale({imperial:!1}).addTo(i),L.control.mousePosition({position:"bottomright",emptyString:"",seperator:" ",latFormatter:function(e){return"Lat "+L.Util.formatNum(e,5)+"°"},lngFormatter:function(e){return"Lng "+L.Util.formatNum(e,5)+"°"}}).addTo(i),d.listenForExtentEvent&&n.$on(d.listenForExtentEvent,function(e,r){u.getMap().then(function(){t(r)})}),d.listenForMarkerEvent&&n.$on(d.listenForMarkerEvent,function(e,n){u.getMap().then(function(){r(n)})}),l&&(l.forEach(function(e){e.resolve(i)}),l=null)},u}])}(r=e.mapview||(e.mapview={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.message",[]).factory("rocks3dMessageService",["$timeout",function(e){var r,n={};return n.message=function(n){var t=document.getElementById("message-details");r&&(r(),r=null),t.innerHTML=n,t.style.display="inline-block",r=e(function(){t.style.display="none"},12e3)},n}])}(r=e.message||(e.message={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.navigator",[]).directive("rocks3dNavigate",["rocks3dNavigatorService",function(e){return{restrict:"AE",scope:{where:"="},link:function(r,n){n.on("click",function(){e.navigate(r.where)})}}}]).directive("rocks3dZoom",["rocks3dNavigatorService",function(e){return{restrict:"AE",scope:{where:"="},link:function(r,n){n.on("click",function(){e.zoom(r.where)})}}}]).factory("rocks3dNavigatorService",["$document","configService",function(e,r){var n={},t=r.getConfig("particles");return n.zoom=function(r){var n=t.getHash(),o=n.zoom+1,a=2*n.x,i=2*n.y,c=e[0];r.x>0&&a++,r.y>0&&i++,t.setHash({x:a,y:i,zoom:o}),c.location="?hash="+t.createParameters()},n.to=function(r){var n=e[0];t.setHash(r),n.location="?hash="+t.createParameters()},n.navigate=function(r){function n(){return r.y?(t.setHash({zoom:c.zoom,x:c.x,y:c.y+r.y}),!0):!1}function o(){return r.x?(t.setHash({zoom:c.zoom,x:c.x+r.x,y:c.y}),!0):!1}function a(){return-1==r.zoom?(t.setHash({zoom:c.zoom+r.zoom,x:Math.floor(c.x/2),y:Math.floor(c.y/2)}),!0):!1}var i=e[0],c=t.getHash(),s=a();s||(s=n(),s||o()),i.location="?hash="+t.createParameters()},n}])}(r=e.navigator||(e.navigator={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.particles",[]).directive("rocks3dParticles",["rocks3dParticlesService",function(e){return{link:function(r,n){e.init(n[0])}}}]).controller("rocks3dParticlesCtrl",["rocks3dParticlesService",function(e){this.data=e.data()}]).factory("rocks3dParticlesService",["$location","$q","$rootScope","$timeout","configService","rocks3dMessageService","rocks3dSurfaceService",function(e,r,n,t,o,a,i){function c(e){T.scene.add(new THREE.AmbientLight(3355443));var r=new THREE.DirectionalLight(16777215);r.position.set(100,500,0),T.scene.add(r)}function s(e){e.properties.hash.z;console.log(R.createFeatures()),r.all([i.prime(e),function(){var e=r.defer();return d3.json(R.createFeatures(),function(r){e.resolve(r)}),e.promise}()]).then(function(r){function o(){window.requestAnimationFrame(o),T.renderer.clear(),T.camera.lookAt(T.scene.position),T.renderer.render(T.scene,T.camera),Y.update()}var c=r[0],s=d3.extent(c),d=r[1];t(function(){C.loaded=d}),d.totalFeatures?d.features.length<d.totalFeatures&&a.message("Only showing "+d.features.length+" of "+d.totalFeatures+", refine your search area"):a.message("There are no features in the selected area."),d.features.forEach(function(e,r){var n=e.properties,t=n.SAMPLE_LONGITUDE,o=n.SAMPLE_ELEVATION,a=n.SAMPLE_LATITUDE,i={x:"undefined"!=typeof t?t:e.geometry.coordinates[0],y:"undefined"!=typeof o?o:e.geometry.coordinates[2],z:"undefined"!=typeof a?a:e.geometry.coordinates[1]};i.y=i.y?i.y:0,y[r]={x:+i.x,y:+i.y,z:+i.z}});var l=e.extent.x,m=d3.extent(y,function(e){return e.y}),v=e.extent.y;m=[Math.min(m[0]?m[0]:0,s[0]),Math.max(m[1]?m[1]:0,s[1])];var x=C.extents={xMax:l[1],xCen:(l[1]+l[0])/2,xMin:l[0],yMax:m[1],yCen:(m[1]+m[0])/2,yMin:m[0],zMax:v[1],zCen:(v[1]+v[0])/2,zMin:v[0],aspectRatio:Math.cos(Math.PI/180*(v[1]+v[0])/2)};x.length=(x.zMax-x.zMin)*S,x.width=x.length*x.aspectRatio,x.height=x.yMax-x.yMin;var h=d3.scale.category20c();T.scale={x:d3.scale.linear().domain(l).range([-50,50]),y:d3.scale.linear().domain(m).range([-50,50]),z:d3.scale.linear().domain(v).range([50,-50])};var k=u(x,T.scale),z=new THREE.LineBasicMaterial({color:0});z.transparent=!0,z.opacity=.3;var w=new THREE.Line(k,z);g.add(w);var b=f("-X");b.position.x=T.scale.x(x.xMin)-12,b.position.y=5,g.add(b);var H=f(E(l[0]));H.position.x=T.scale.x(x.xMin)-12,H.position.y=-5,g.add(H);var b=f("X");b.position.x=T.scale.x(x.xMax)+12,b.position.y=5,g.add(b);var H=f(E(l[1]));H.position.x=T.scale.x(x.xMax)+12,H.position.y=-5,g.add(H);var I=f("-Z");I.position.y=T.scale.y(x.yMin)-5,g.add(I);var P=f(E(m[0]));P.position.y=T.scale.y(x.yMin)-15,g.add(P);var I=f("Z");I.position.y=T.scale.y(x.yMax)+30,g.add(I);var P=f(E(m[1]));P.position.y=T.scale.y(x.yMax)+20,g.add(P);var L=f("-Y "+E(v[0]));L.position.z=T.scale.z(x.zMin)+2,g.add(L);var L=f("Y "+E(v[1]));L.position.z=T.scale.z(x.zMax)+2,g.add(L);var O=new THREE.PointsMaterial({vertexColors:THREE.VertexColors,size:10}),F=y.length;M=[];for(var G=new THREE.Geometry,_=0;F>_;_++){var N=T.scale.x(y[_].x),A=T.scale.y(y[_].y),B=T.scale.z(y[_].z),U=new THREE.Vector3(N,A,B);M.push(U),G.vertices.push(U),G.colors.push((new THREE.Color).setRGB(p(h(""+_)).r/255,p(h(""+_)).g/255,p(h(""+_)).b/255))}F>0&&(G.computeBoundingSphere(),G.boundingSphere.radius<5&&(console.log("Overriding bounding sphere radius"+G.boundingSphere.radius),G.boundingSphere.radius=5));var W=M=new THREE.Points(G,O);g.add(W),T.renderer.render(T.scene,T.camera),C.loaded=d,g.scale.x=g.scale.x*x.aspectRatio,i.render(C,T);var D=((new Date).getTime(),!1),$=0,V=0;T.renderer.domElement.onmousedown=function(e){var r=T.renderer.domElement.getBoundingClientRect();D=!0,$=e.clientX,V=e.clientY;var t=new THREE.Vector2;t.x=(e.clientX-r.left)/T.renderer.domElement.clientWidth*2-1,t.y=2*-((e.clientY-r.top)/T.renderer.domElement.clientHeight)+1,n.$broadcast(R.rendererSelectEventName,t)},T.renderer.domElement.onmouseup=function(){D=!1};var X=new THREE.Raycaster;T.renderer.domElement.onmousemove=function(e){function r(e){var r,n,t=e.properties;if(t&&!t.html){r="<div class='popup-header'><strong>ID: </strong><a class='title-link' target='_blank' href='"+R.dataUrl.replace("{id}",e.id)+"'>"+e.id+"</a></div>Lon/lat elev: "+e.geometry.coordinates[0].toFixed(6)+"/"+e.geometry.coordinates[1].toFixed(6)+" "+("undefined"==typeof e.geometry.coordinates[2]?"-":e.geometry.coordinates[2]),n="<br/>";for(var o in t)t.hasOwnProperty(o)&&(r+=n+o+"<br/>&#160;"+t[o]);t.html=r}return e}var t,o=T.renderer.domElement.getBoundingClientRect(),a=new THREE.Vector2;e.preventDefault(),a.x=(e.clientX-o.left)/T.renderer.domElement.clientWidth*2-1,a.y=2*-((e.clientY-o.top)/T.renderer.domElement.clientHeight)+1,X.setFromCamera(a,T.camera);var i=X.intersectObject(W,!0);i.length>0&&(t=d.features[i[0].index],n.$broadcast(R.onhoverEventName,r(t)))};var Y=new THREE.OrbitControls(T.camera,T.renderer.domElement);o()})}function u(e,r){var n=r.x,t=r.y,o=r.z,a=new THREE.Geometry;return a.vertices.push(d(n(e.xMin),t(e.yMax),o(e.zMin)),d(n(e.xMin),t(e.yMax),o(e.zMax)),d(n(e.xMax),t(e.yMax),o(e.zMax)),d(n(e.xMax),t(e.yMax),o(e.zMin)),d(n(e.xMax),t(e.yMin),o(e.zMin)),d(n(e.xMax),t(e.yMin),o(e.zMax)),d(n(e.xMin),t(e.yMin),o(e.zMax)),d(n(e.xMin),t(e.yMin),o(e.zMin)),d(n(e.xMin),t(e.yMax),o(e.zMin)),d(n(e.xCen),t(e.yMax),o(e.zMin)),d(n(e.xCen),t(e.yMax),o(e.zCen)),d(n(e.xCen),t(e.yMin),o(e.zCen)),d(n(e.xMin),t(e.yMin),o(e.zCen)),d(n(e.xMin),t(e.yMax),o(e.zCen)),d(n(e.xMax),t(e.yMax),o(e.zCen)),d(n(e.xMax),t(e.yMin),o(e.zCen)),d(n(e.xCen),t(e.yMin),o(e.zCen)),d(n(e.xCen),t(e.yMin),o(e.zMax)),d(n(e.xCen),t(e.yCen),o(e.zMax)),d(n(e.xMax),t(e.yCen),o(e.zMax)),d(n(e.xMax),t(e.yCen),o(e.zMin)),d(n(e.xMin),t(e.yCen),o(e.zMin)),d(n(e.xMin),t(e.yCen),o(e.zMax)),d(n(e.xCen),t(e.yCen),o(e.zMax)),d(n(e.xCen),t(e.yCen),o(e.zMin)),d(n(e.xCen),t(e.yMax),o(e.zMin)),d(n(e.xCen),t(e.yMin),o(e.zMin)),d(n(e.xCen),t(e.yMin),o(e.zMax)),d(n(e.xMax),t(e.yMin),o(e.zMax)),d(n(e.xMax),t(e.yMax),o(e.zMax)),d(n(e.xMax),t(e.yMax),o(e.zMin)),d(n(e.xCen),t(e.yMax),o(e.zMin)),d(n(e.xCen),t(e.yMax),o(e.zMax)),d(n(e.xCen),t(e.yCen),o(e.zMax)),d(n(e.xCen),t(e.yMin),o(e.zMax)),d(n(e.xMin),t(e.yMin),o(e.zMax)),d(n(e.xMin),t(e.yMax),o(e.zMax)),d(n(e.xMin),t(e.yMax),o(e.zCen)),d(n(e.xMin),t(e.yCen),o(e.zCen)),d(n(e.xMax),t(e.yCen),o(e.zCen)),d(n(e.xMax),t(e.yCen),o(e.zMax)),d(n(e.xMax),t(e.yMin),o(e.zMax)),d(n(e.xMin),t(e.yMin),o(e.zMax)),d(n(e.xMin),t(e.yMin),o(e.zMin)),d(n(e.xMax),t(e.yMin),o(e.zMin))),a}function d(e,r,n){return new THREE.Vector3(e,r,n)}function l(e,r,n,t){t=t||16;var o=document.createElement("canvas"),a=o.getContext("2d"),i=t+"px "+(n||"Arial");a.font=i;var c=a.measureText(e).width,s=Math.ceil(t);return o.width=c,o.height=s,a.font=i,a.fillStyle=r||"black",a.fillText(e,0,Math.ceil(.8*t)),o}function f(e,r,n,t,o,a){var i=l(e,r,n,t),c=new THREE.PlaneGeometry(i.width,i.height,o,a),s=new THREE.Texture(i);s.needsUpdate=!0;var u=new THREE.MeshBasicMaterial({map:s,color:16777215,transparent:!0}),d=new THREE.Mesh(c,u);return d.scale.set(.5,.5,.5),d}function p(e){var r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}function m(){function r(e){var r=[];return e&&(r=angular.isArray(e)?e.map(function(e){return"&filter="+encodeURIComponent(e)}):["&filter="+encodeURIComponent(e)]),r}function n(e){var r=function n(r){var t=e[r];return"undefined"!=typeof t&&(R[r]=t),n};return r}var t=e.search(),o=n(t);o("x")("y")("zoom")("hash")("filter"),R.createTileInfo=function(){return this.hash?this.url+"tileInfo"+(0!=this.hash.indexOf("/")?"/":"")+this.hash:this.url+"tileInfo?"+this.createPointParameters()},R.createFeatures=function(){return this.url+"features"+this.createParameters()},R.createParameters=function(){return this.hash?"/"+this.hash+"?maxCount="+this.maxCount+r(this.filter).join(""):"?"+this.createPointParameters()+"&maxCount="+this.maxCount+r(this.filter).join("")},R.createPointParameters=function(){return"x="+this.x+"&y="+this.y+"&zoom="+this.zoom},R.setHash=function(e){this.hash=e.zoom+"/"+e.x+"/"+e.y},R.getHash=function(){var e=0,r=this.hash.split("/");return 4==r.length&&(e=1),{zoom:parseInt(r[e++]),x:parseFloat(r[e++]),y:parseFloat(r[e])}}}var v,x,g,E,y,M,h,S=111320,k={},R=o.getConfig("particles"),C={},T={data:C};return m(),k.scene=function(){return T},k.data=function(){return C},k.init=function(e){var r=e.getBoundingClientRect();v=r.width,x=r.height,T.renderer=new THREE.WebGLRenderer({antialias:!0}),T.renderer.setSize(v,x),e.appendChild(T.renderer.domElement),T.renderer.setClearColor(16777215,1),T.camera=new THREE.PerspectiveCamera(45,v/x,1,1e4),T.camera.position.z=200,T.camera.position.x=-100,T.camera.position.y=100,T.scene=new THREE.Scene,h=THREEExt.WindowResize(T.renderer,T.camera,e),g=T.container=new THREE.Object3D,T.scene.add(g),g.rotation.y=0,y=[],E=d3.format("+.5f"),d3.json(R.createTileInfo(),function(e){t(function(){C.tileInfo=e,n.$broadcast(R.onloadEventName,e)});var r=e.properties.hash;R.hash=r.z+"/"+r.x+"/"+r.y,e.extent={x:[e.bbox[0],e.bbox[2]],y:[e.bbox[1],e.bbox[3]]},s(e)}),c(T.scene)},k}])}(r=e.particles||(e.particles={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){function r(e,r,n){return e.replace(/\{resolution\}/g,""+n).replace("{bbox}",r.bbox)}angular.module("rocks3d.multisurface",[]).directive("rocks3dSurface",["rocks3dSurfaceService",function(e){return{link:function(e){}}}]).provider("rocks3dSurfaceService",[function(){var e="rocks3d/resources/config/surfaces.json",n=null;this.location=function(r){e=r};var t={},o=null;this.$get=["$http","$q","$rootScope","$timeout","configService",function(a,i,c,s,u){var d={},l=u.getConfig("surface");return d.getMetadata=function(){if(n)return i.when(n);var r=i.defer();return o?o.push(r):(o=[r],a.get(e,{cache:!0}).then(function(e){n=e.data,o.forEach(function(e){e.resolve(n)})})),r.promise},d.data=function(){return t},d.prime=function(e){function n(e){console.log("Tadah!"),console.log(e)}var t=i.defer();return d.getMetadata().then(function(t){t.features.forEach(function(t){var o=t.properties.urlTemplates;if(t.properties.show){var a=new THREE.DataSurfaceLoader;a.load(r(o.elevation,e,l.resolution),r(o.imagery,e,l.resolution),n)}})}),t.promise},d}]}])}(r=e.multisurface||(e.multisurface={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.surface",[]).directive("rocks3dSurface",["rocks3dSurfaceService",function(e){return{link:function(e){}}}]).factory("rocks3dSurfaceService",["$q","$rootScope","$timeout","configService",function(e,r,n,t){function o(e){return e[0]+","+e[1]+","+e[2]+","+e[3]}var a,i,c,s,u,d,l={},f=t.getConfig("surface"),p={};return l.data=function(){return p},l.prime=function(r){u=r;var n=e.defer(),t=f.elevation1SecUrl;t=t.replace(/\{resolution\}/g,f.resolution),t=t.replace("{bbox}",r.bbox);var o=new THREE.GeotiffTerrainLoader;return o.load(t,function(e){s=e,n.resolve(e)}),n.promise},l.checkElevation=function(e){var r=new THREE.Raycaster,n=d;r.setFromCamera(e,n.camera);var t=r.intersectObject(i,!0);t.length>0&&(console.log("Intersects"),console.log(i),console.log(t[0]))},l.render=function(e,r){d=r,c=e;e.loaded,e.extents.yCen;if(u.properties.hash.z<4)return!1;var t=o(u.bbox),l=f.imageryUrls.national.url,m=e.extents,v=f.imageryUrls.nsw.extent;m.xMin>v.xmin&&m.xMax<v.xmax&&m.zMin>v.ymin&&m.zMax<v.ymax&&(l=f.imageryUrls.nsw.url);var x=new THREE.TextureLoader;x.crossOrigin="";var g=new THREE.MeshPhongMaterial({map:x.load(l.replace("{bbox}",t)),transparent:!0,opacity:f.surfaceOpacity});return n(function(){p.surface=g}),a=new THREE.PlaneGeometry(100,100,199,199),i=new THREE.Mesh(a,g),i.rotation.x=-Math.PI/2,a.vertices.forEach(function(e,r){e.z=d.scale.y(s[r])}),a.computeFaceNormals(),a.computeVertexNormals(),d.container.add(i),{plane:i}},l}])}(r=e.surface||(e.surface={}))}(rocks3d||(rocks3d={}));var rocks3d;!function(e){var r;!function(e){angular.module("rocks3d.view",[]).directive("rocks3dView",[function(){return{templateUrl:"rocks3d/view/view.html"}}]).directive("rocks3dSurfaceOpacity",[function(){return{templateUrl:"rocks3d/view/surfaceopacity.html",link:function(e,r){}}}]).directive("rocks3dVerticalExaggerate",["rocks3dParticlesService",function(e){var r=[1e-4,2e-4,5e-4,.001,.002,.005,.01,.02,.05,.1,.2,.5,1];return{templateUrl:"rocks3d/view/verticalexaggerate.html",scope:{direction:"="},link:function(n,t){function o(){var t=e.scene(),o=t.container.scale;o.y=r[n.index],o.z=1-.1*(n.index-12),o.x=t.data.extents.aspectRatio*(1-.1*(n.index-12))}n.index=12,n.range=r,n.smaller=function(){n.index--,o()},n.larger=function(){n.index++,o()},n.oneToOne=function(){var r=e.scene(),n=r.data.extents,t=n.length,o=n.height,a=o/t;r.container.scale.y=a}}}}]).directive("rocks3dSurfaceOpacity",["rocks3dSurfaceService",function(e){return{link:function(r){r.data=e.data()}}}])}(r=e.view||(e.view={}))}(rocks3d||(rocks3d={})),angular.module("rocks3d.templates",[]).run(["$templateCache",function(e){e.put("rocks3d/view/surfaceopacity.html",'<span style="float:right; z-index:3">\r\n	Surface opacity\r\n	<input ng-model="data.surface.opacity" type="range" min="0" max="1" step="0.05"></input>\r\n</span>'),e.put("rocks3d/view/verticalexaggerate.html",'<span class="verticalExaggerateContainer">\r\n	<button ng-click="smaller()" ng-disabled="!index">Less</button> \r\n	Vertical exaggeration\r\n	<button ng-click="larger()" ng-disabled="range[index] == 1">More</button> \r\n	<!-- <button ng-click="oneToOne()">One to One</button> -->\r\n</span>'),e.put("rocks3d/view/view.html",'<rocks3d-vertical-exaggerate></rocks3d-vertical-exaggerate>\r\n<rocks3d-surface-opacity ng-show="data.surface"></rocks3d-surface-opacity>')}]);
//# sourceMappingURL=rocks3d.min.js.map
